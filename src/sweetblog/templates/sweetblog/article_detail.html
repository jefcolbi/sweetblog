{% extends base_template %}
{% load i18n %}
{% load static %}

{% block title %}{{ article.title }} - {{ blog_name }}{% endblock %}

{% block content %}
<article style="margin-top: 10vh;">
    <header>
        <h1>{{ article.title }}</h1>
        <p>
            <small>
                By {{ article.created_by.get_full_name|default:article.created_by.username }}
                on {{ article.created_at|date:"F d, Y" }}
                {% if article.collection %}
                in <a href="{{ article.collection.get_url }}">{{ article.collection.name }}</a>
                {% endif %}
                <br/>
                {% translate 'Reading time' %}: {{ avg_read_duration|cut:" days, 0:00:00" }} {% translate 'minutes' %}
            </small>
        </p>
    </header>
    
    {% if article.image %}
    <figure>
        <img src="{{ article.image.url }}" alt="{{ article.title }}">
    </figure>
    {% endif %}
    
    <div class="article-content" style="margin-top: 50px;">
        {{ article.generated_html|safe }}
    </div>
    
    <!-- Like/Dislike buttons -->
    <div style="margin: 2rem 0; display: flex; gap: 1rem; align-items: center;">
        <button id="like-btn" class="like-dislike-btn" data-action="like" style="background: grey; border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="{% if liked %}gold{% else %}none{% endif %}" stroke="{% if liked %}gold{% else %}currentColor{% endif %}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
            </svg>
            <span><span id="like-count">{{ like_count }}</span> Likes</span>
        </button>
        
        <button id="dislike-btn" class="like-dislike-btn" data-action="dislike" style="background: grey; border: 1px solid #ccc; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="{% if disliked %}red{% else %}none{% endif %}" stroke="{% if disliked %}red{% else %}currentColor{% endif %}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path>
            </svg>
            <span><span id="dislike-count">{{ dislike_count }}</span> Dislikes</span>
        </button>
    </div>
    
    {% if article.tags.all %}
    <footer>
        <p>Tags:
        {% for tag in article.tags.all %}
        <a href="{% url 'sweetblog-tag_detail' slug=tag.slug %}" class="tag">{{ tag.name }}</a>
        {% endfor %}
        </p>
    </footer>
    {% endif %}
</article>

<!-- Comments Section -->
<section style="margin-top: 3rem;">
    <h2>Comments ({{ comment_count }})</h2>
    
    <!-- Main comment form for top-level comments -->
    {% if user.is_authenticated %}
    <div id="main-comment-form" style="margin: 1.5rem 0;">
        {% csrf_token %}
        <textarea id="main-comment-content" 
                  placeholder="Write a comment..." 
                  style="width: 100%; min-height: 100px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 5px; resize: vertical;"></textarea>
        <button onclick="submitComment()" 
                style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Post Comment
        </button>
    </div>
    {% else %}
    <div>-- {% translate 'Signin to comment' %} --</div>
    {% endif %}
    
    <!-- Comments list -->
    <div id="comments-container" style="margin-top: 2rem;">
        {% for comment in comments %}

        <div class="comment" 
             data-comment-id="{{ comment.node.id }}"
             data-level="1"
             style="margin-left: 1rem; margin-bottom: 1rem; padding: 1rem; border-left: 2px solid #e0e0e0;">
            
            <!-- Comment header with username and date -->
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                <strong>{{ comment.node.device.user.username }}</strong> •
                <span>{{ comment.node.created_at|date:"F d, Y at g:i A" }}</span>
            </div>
            
            <!-- Comment content -->
            <div style="margin-bottom: 0.5rem; line-height: 1.5;">
                {{ comment.node.content|linebreaks }}
            </div>

            {% for child_comment in comment.tree %}
                <div class="comment"
                    data-comment-id="{{ comment.node.id }}"
                    data-level="2"
                    style="margin-left: 2rem; margin-bottom: 1rem; padding: 1rem; border-left: 2px solid #e0e0e0;">
                    <!-- Comment header with username and date -->
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">
                        <strong>{{ child_comment.node.device.user.username }}</strong> •
                        <span>{{ child_comment.node.created_at|date:"F d, Y at g:i A" }}</span>
                    </div>

                    <!-- Comment content -->
                    <div style="margin-bottom: 0.5rem; line-height: 1.5;">
                        {{ child_comment.node.content|linebreaks }}
                    </div>
                </div>
            {% endfor %}

            <!-- Hidden reply form -->
            <div id="reply-form-{{ comment.node.id }}" style="display: none; margin-top: 1rem;">
                <textarea id="reply-content-{{ comment.node.id }}"
                          placeholder="Write a reply..."
                          style="width: 100%; min-height: 80px; padding: 0.5rem; border: 1px solid #ccc; border-radius: 5px; resize: vertical;"></textarea>
                <div style="margin-top: 0.5rem;">
                    <button onclick="submitReply({{ comment.node.id }})"
                            style="padding: 0.25rem 0.75rem; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 0.5rem;">
                        Post Reply
                    </button>
                    <button onclick="hideReplyForm({{ comment.node.id }})"
                            style="padding: 0.25rem 0.75rem; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            </div>

            <!-- Second level comment: reply to parent (becomes sibling) -->
            {% if user.is_authenticated %}
            <button class="reply-btn"
                    onclick="showReplyForm({{ comment.node.id }}, {{ comment.node.id }})"
                    style="font-size: 0.9rem; padding: 0.25rem 0.75rem; background: orange; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;">
                Reply
            </button>
            {% endif %}
        </div>
        {% empty %}
        <p style="color: #666; font-style: italic;">No comments yet. Be the first to comment!</p>
        {% endfor %}
    </div>
</section>

{% if related_articles %}
<section>
    <h2>More from {{ article.collection.name }}</h2>
    <div class="grid">
        {% for related in related_articles %}
        <article style="margin-bottom: 5vh;">
            <header style="display: flex; align-items: flex-start; justify-content: space-between;">
                <div style="display: flex; align-items: flex-start;">
                    <img src="{{ related.thumbnail.url }}" alt="{{ related.title }}"
                         style="margin-right: 10px; width: 10vw;">
                    <h2><a href="{{ related.get_url }}">{{ related.title }}</a></h2>
                </div>
            </header>
        
            <p>{{ related.description|truncatewords:30 }}</p>
        
            <footer>
                <small>
                    By {{ related.created_by.get_full_name|default:related.created_by.username }}
                    on {{ related.created_at|date:"F d, Y" }}
                    {% if related.collection %}
                    in <a href="{{ related.collection.get_url }}">{{ related.collection.name }}</a>
                    {% endif %}
                </small>
            </footer>
        </article>
        {% endfor %}
    </div>
</section>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Pass Django variables to JavaScript
    window.articleId = {{ article.id }};
    window.articleType = 'markdownarticle';
    window.csrfToken = '{{ csrf_token }}';
    window.likeDislikeUrl = "{% url 'sweetblog-like_dislike' %}";
    window.markAsReadUrl = "{% url 'sweetblog-mark_as_read' %}";
    window.submitCommentUrl = "{% url 'sweetblog-submit_comment' %}";
</script>
<script src="{% static 'sweetblog/js/article.js' %}"></script>
{% endblock %}